
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    <title>&#20250;&#35805;</title>
  
    <link rel="stylesheet" href="_static/scrolls.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="next" title="&#25968;&#25454;&#24211; &#27010;&#36848;" href="Database-General-zh.html" />
    <link rel="prev" title="&#35270;&#22270;" href="View-zh.html" /> 
  </head><body>
    <div id="content">
      <div class="header">
        <h1 class="heading"><a href="index.html"
          title="back to the documentation overview"><span>&#20250;&#35805;</span></a></h1>
      </div>
      <div class="relnav" role="navigation" aria-label="related navigation">
        <a href="View-zh.html">&laquo; &#35270;&#22270;</a> |
        <a href="#">&#20250;&#35805;</a>
        | <a href="Database-General-zh.html">&#25968;&#25454;&#24211; &#27010;&#36848; &raquo;</a>
      </div>
      <div id="contentwrapper">
        <div id="toc" role="navigation" aria-label="table of contents navigation">
          <h3>Table Of Contents</h3>
          <ul>
<li><a class="reference internal" href="#">&#20250;&#35805;</a><ul>
<li><a class="reference internal" href="#id4">&#20250;&#35805;&#23545;&#35937;</a></li>
<li><a class="reference internal" href="#id5">&#20250;&#35805;&#30340;&#20363;&#23376;</a></li>
</ul>
</li>
</ul>

        </div>
        
  <div class="section" id="id1">
<h1>&#20250;&#35805;</h1>
<p><a href="#id2"><span class="problematic" id="id3">*</span></a>&#20250;&#35805;&#65288;Session&#65289;*&#26159;web&#24212;&#29992;&#30340;&#37325;&#35201;&#27010;&#24565;&#65292;&#29992;&#20110;&#22312;&#26381;&#21153;&#31471;&#20445;&#23384;&#23458;&#25143;&#31471;&#30340;&#29366;&#24577;&#65292;&#19968;&#33324;&#21644;&#27983;&#35272;&#22120;&#30340;cookie&#37197;&#21512;&#65292;drogon&#25552;&#20379;&#20102;&#23545;&#20250;&#35805;&#30340;&#25903;&#25345;&#12290;drogon&#40664;&#35748;&#20851;&#38381;&#20250;&#35805;&#36873;&#25321;&#65292;&#20320;&#20063;&#21487;&#20197;&#36890;&#36807;&#22914;&#19979;&#25509;&#21475;&#20851;&#38381;&#25110;&#25171;&#24320;&#65306;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">disableSession</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">enableSession</span><span class="p">(</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>&#37117;&#26159;&#36890;&#36807;*HttpAppFramework*&#21333;&#20363;&#35843;&#29992;&#65292;timeout&#21442;&#25968;&#20195;&#34920;&#20102;&#20250;&#35805;&#22833;&#25928;&#30340;&#26102;&#38388;&#65292;&#21333;&#20301;&#26159;&#31186;&#65292;&#26694;&#26550;&#40664;&#35748;&#20540;&#26159;1200&#65292;&#21363;&#22914;&#26524;&#29992;&#25143;20&#20998;&#38047;&#20197;&#19978;&#27809;&#26377;&#35775;&#38382;&#24212;&#29992;&#65292;&#21017;&#20182;&#23545;&#24212;&#30340;&#20250;&#35805;&#23601;&#22833;&#25928;&#20102;&#12290;timeout&#35774;&#32622;&#20026;0&#34920;&#31034;drogon&#23558;&#22312;&#25972;&#20010;&#29983;&#23384;&#26399;&#20445;&#30041;&#29992;&#25143;&#30340;&#20250;&#35805;&#65307;</p>
<p>&#25171;&#24320;&#20250;&#35805;&#29305;&#24615;&#21069;&#35831;&#30830;&#23450;&#20320;&#30340;&#23458;&#25143;&#31471;&#25903;&#25345;cookie&#65292;&#21542;&#21017;&#65292;drogon&#20250;&#20026;&#27599;&#27425;&#19981;&#21547;SessionID&#30340;&#35831;&#27714;&#21019;&#24314;&#26032;&#30340;&#20250;&#35805;&#65292;&#36825;&#20250;&#30333;&#30333;&#28010;&#36153;&#20869;&#23384;&#21644;&#35745;&#31639;&#36164;&#28304;&#12290;</p>
<div class="section" id="id4">
<h2>&#20250;&#35805;&#23545;&#35937;</h2>
<p>drogon&#30340;&#20250;&#35805;&#23545;&#35937;&#31867;&#22411;&#26159;*drogon::Session*&#65292;&#23427;&#21644;*HttpViewData*&#38750;&#24120;&#31867;&#20284;&#65292;&#21487;&#20197;&#36890;&#36807;&#20851;&#38190;&#23383;&#23384;&#21462;&#20219;&#24847;&#31867;&#22411;&#30340;&#23545;&#35937;&#65307;&#25903;&#25345;&#24182;&#21457;&#35835;&#20889;&#65307;&#20855;&#20307;&#30340;&#20351;&#29992;&#35831;&#21442;&#32771;Session class&#30340;&#35828;&#26126;&#65307;</p>
<p>drogon&#26694;&#26550;&#20250;&#25226;&#20250;&#35805;&#23545;&#35937;&#25918;&#21040;HttpRequest&#23545;&#35937;&#37324;&#20256;&#36882;&#32473;&#29992;&#25143;&#65292;&#29992;&#25143;&#21487;&#20197;&#36890;&#36807;HttpRequest&#31867;&#30340;&#22914;&#19979;&#25509;&#21475;&#33719;&#21462;Session&#23545;&#35937;&#12290;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SessionPtr</span> <span class="nf">session</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>&#33719;&#24471;&#30340;&#26159;Session&#23545;&#35937;&#30340;&#26234;&#33021;&#25351;&#38024;&#65292;&#36890;&#36807;&#23427;&#21487;&#20197;&#23384;&#21462;&#21508;&#31181;&#23545;&#35937;&#65307;</p>
</div>
<div class="section" id="id5">
<h2>&#20250;&#35805;&#30340;&#20363;&#23376;</h2>
<p>&#25105;&#20204;&#36825;&#27425;&#21152;&#19968;&#20010;&#38656;&#35201;&#20250;&#35805;&#25903;&#25345;&#30340;&#21151;&#33021;&#65292;&#27604;&#22914;&#65292;&#25105;&#20204;&#35201;&#38480;&#21046;&#29992;&#25143;&#30340;&#35775;&#38382;&#39057;&#24230;&#65292;&#26576;&#19968;&#27425;&#35775;&#38382;&#21518;&#65292;&#22914;&#26524;10&#31186;&#20197;&#20869;&#20877;&#27425;&#35775;&#38382;&#65292;&#23601;&#36820;&#22238;&#38169;&#35823;&#65292;&#21542;&#21017;&#36820;&#22238;ok&#12290;&#25105;&#20204;&#38656;&#35201;&#22312;&#20250;&#35805;&#37324;&#35760;&#24405;&#19978;&#27425;&#35775;&#38382;&#30340;&#26102;&#38388;&#65292;&#28982;&#21518;&#21644;&#26412;&#27425;&#35775;&#38382;&#30340;&#26102;&#38388;&#20570;&#27604;&#36739;&#65292;&#23601;&#21487;&#20197;&#23454;&#29616;&#36825;&#20010;&#21151;&#33021;&#12290;</p>
<p>&#25105;&#20204;&#21019;&#24314;&#19968;&#20010;Filter&#26469;&#23454;&#29616;&#36825;&#20010;&#21151;&#33021;&#65292;&#20551;&#35774;&#31867;&#21517;&#26159;TimeFilter&#65292;&#23454;&#29616;&#22914;&#19979;&#65306;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;TimeFilter.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;trantor/utils/Date.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;trantor/utils/Logger.h&gt;</span><span class="cp"></span>
<span class="cp">#define VDate &quot;visitDate&quot;</span>
<span class="kt">void</span> <span class="n">TimeFilter</span><span class="o">::</span><span class="n">doFilter</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
                        <span class="n">FilterCallback</span> <span class="o">&amp;&amp;</span><span class="n">cb</span><span class="p">,</span>
                        <span class="n">FilterChainCallback</span> <span class="o">&amp;&amp;</span><span class="n">ccb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">trantor</span><span class="o">::</span><span class="n">Date</span> <span class="n">now</span><span class="o">=</span><span class="n">trantor</span><span class="o">::</span><span class="n">Date</span><span class="o">::</span><span class="n">date</span><span class="p">();</span>
    <span class="n">LOG_TRACE</span><span class="o">&lt;&lt;</span><span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">VDate</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">lastDate</span><span class="o">=</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get</span><span class="o">&lt;</span><span class="n">trantor</span><span class="o">::</span><span class="n">Date</span><span class="o">&gt;</span><span class="p">(</span><span class="n">VDate</span><span class="p">);</span>
        <span class="n">LOG_TRACE</span><span class="o">&lt;&lt;</span><span class="s">&quot;last:&quot;</span><span class="o">&lt;&lt;</span><span class="n">lastDate</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">VDate</span><span class="p">,</span><span class="n">now</span><span class="p">);</span>
        <span class="n">LOG_TRACE</span><span class="o">&lt;&lt;</span><span class="s">&quot;update visitDate&quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">now</span><span class="o">&gt;</span><span class="n">lastDate</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//10 sec later can visit again;</span>
            <span class="n">ccb</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">Json</span><span class="o">::</span><span class="n">Value</span> <span class="n">json</span><span class="p">;</span>
            <span class="n">json</span><span class="p">[</span><span class="s">&quot;result&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">;</span>
            <span class="n">json</span><span class="p">[</span><span class="s">&quot;message&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;Access interval should be at least 10 seconds&quot;</span><span class="p">;</span>
            <span class="k">auto</span> <span class="n">res</span><span class="o">=</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">newHttpJsonResponse</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
            <span class="n">cb</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">LOG_TRACE</span><span class="o">&lt;&lt;</span><span class="s">&quot;first access,insert visitDate&quot;</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">VDate</span><span class="p">,</span><span class="n">now</span><span class="p">);</span>
    <span class="n">ccb</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>&#25105;&#20204;&#20877;&#27880;&#20876;&#19968;&#20010;lambda&#34920;&#36798;&#24335;&#21040;/slow&#36335;&#24452;&#19978;&#65292;&#21516;&#26102;&#38468;&#21152;&#19978;TimeFilter&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">drogon</span><span class="o">::</span><span class="n">HttpAppFramework</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span>
            <span class="p">.</span><span class="n">registerHttpMethod</span><span class="p">(</span><span class="s">&quot;/slow&quot;</span><span class="p">,</span>
                               <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
                                   <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">HttpResponsePtr</span> <span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">callback</span><span class="p">)</span>
                               <span class="p">{</span>
                                   <span class="n">Json</span><span class="o">::</span><span class="n">Value</span> <span class="n">json</span><span class="p">;</span>
                                   <span class="n">json</span><span class="p">[</span><span class="s">&quot;result&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;ok&quot;</span><span class="p">;</span>
                                   <span class="k">auto</span> <span class="n">resp</span><span class="o">=</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">newHttpJsonResponse</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
                                   <span class="n">callback</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
                               <span class="p">},</span>
                               <span class="p">{</span><span class="n">Get</span><span class="p">,</span><span class="s">&quot;TimeFilter&quot;</span><span class="p">});</span>
</pre></div>
</div>
<p>&#35843;&#29992;&#26694;&#26550;&#25509;&#21475;&#25171;&#24320;&#20250;&#35805;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">drogon</span><span class="o">::</span><span class="n">HttpAppFramework</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">enableSession</span><span class="p">(</span><span class="mi">1200</span><span class="p">);</span>
</pre></div>
</div>
<p>&#29992;cmake&#37325;&#26032;&#32534;&#35793;&#25972;&#20010;&#24037;&#31243;&#65292;&#36816;&#34892;&#30446;&#26631;&#31243;&#24207;webapp&#65292;&#23601;&#21487;&#20197;&#36890;&#36807;&#27983;&#35272;&#22120;&#30475;&#21040;&#25928;&#26524;&#20102;&#12290;</p>
</div>
</div>


      </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, an-tao.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>