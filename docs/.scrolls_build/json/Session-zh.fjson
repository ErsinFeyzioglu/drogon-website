{"parents": [{"link": "../index-zh/", "title": "\u4e2d\u6587\u6587\u6863"}], "prev": {"link": "../View-zh/", "title": "\u89c6\u56fe"}, "next": {"link": "../Database-General-zh/", "title": "\u6570\u636e\u5e93 \u6982\u8ff0"}, "title": "\u4f1a\u8bdd", "meta": {}, "body": "<div class=\"section\" id=\"id1\">\n<h1>\u4f1a\u8bdd<a class=\"headerlink\" href=\"#id1\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p><a href=\"#id2\"><span class=\"problematic\" id=\"id3\">*</span></a>\u4f1a\u8bdd\uff08Session\uff09*\u662fweb\u5e94\u7528\u7684\u91cd\u8981\u6982\u5ff5\uff0c\u7528\u4e8e\u5728\u670d\u52a1\u7aef\u4fdd\u5b58\u5ba2\u6237\u7aef\u7684\u72b6\u6001\uff0c\u4e00\u822c\u548c\u6d4f\u89c8\u5668\u7684cookie\u914d\u5408\uff0cdrogon\u63d0\u4f9b\u4e86\u5bf9\u4f1a\u8bdd\u7684\u652f\u6301\u3002drogon\u9ed8\u8ba4\u5173\u95ed\u4f1a\u8bdd\u9009\u62e9\uff0c\u4f60\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u63a5\u53e3\u5173\u95ed\u6216\u6253\u5f00\uff1a</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kt\">void</span> <span class=\"nf\">disableSession</span><span class=\"p\">();</span>\n<span class=\"kt\">void</span> <span class=\"nf\">enableSession</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"kt\">size_t</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n<p>\u90fd\u662f\u901a\u8fc7*HttpAppFramework*\u5355\u4f8b\u8c03\u7528\uff0ctimeout\u53c2\u6570\u4ee3\u8868\u4e86\u4f1a\u8bdd\u5931\u6548\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\u662f\u79d2\uff0c\u6846\u67b6\u9ed8\u8ba4\u503c\u662f1200\uff0c\u5373\u5982\u679c\u7528\u623720\u5206\u949f\u4ee5\u4e0a\u6ca1\u6709\u8bbf\u95ee\u5e94\u7528\uff0c\u5219\u4ed6\u5bf9\u5e94\u7684\u4f1a\u8bdd\u5c31\u5931\u6548\u4e86\u3002timeout\u8bbe\u7f6e\u4e3a0\u8868\u793adrogon\u5c06\u5728\u6574\u4e2a\u751f\u5b58\u671f\u4fdd\u7559\u7528\u6237\u7684\u4f1a\u8bdd\uff1b</p>\n<p>\u6253\u5f00\u4f1a\u8bdd\u7279\u6027\u524d\u8bf7\u786e\u5b9a\u4f60\u7684\u5ba2\u6237\u7aef\u652f\u6301cookie\uff0c\u5426\u5219\uff0cdrogon\u4f1a\u4e3a\u6bcf\u6b21\u4e0d\u542bSessionID\u7684\u8bf7\u6c42\u521b\u5efa\u65b0\u7684\u4f1a\u8bdd\uff0c\u8fd9\u4f1a\u767d\u767d\u6d6a\u8d39\u5185\u5b58\u548c\u8ba1\u7b97\u8d44\u6e90\u3002</p>\n<div class=\"section\" id=\"id4\">\n<h2>\u4f1a\u8bdd\u5bf9\u8c61<a class=\"headerlink\" href=\"#id4\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>drogon\u7684\u4f1a\u8bdd\u5bf9\u8c61\u7c7b\u578b\u662f*drogon::Session*\uff0c\u5b83\u548c*HttpViewData*\u975e\u5e38\u7c7b\u4f3c\uff0c\u53ef\u4ee5\u901a\u8fc7\u5173\u952e\u5b57\u5b58\u53d6\u4efb\u610f\u7c7b\u578b\u7684\u5bf9\u8c61\uff1b\u652f\u6301\u5e76\u53d1\u8bfb\u5199\uff1b\u5177\u4f53\u7684\u4f7f\u7528\u8bf7\u53c2\u8003Session class\u7684\u8bf4\u660e\uff1b</p>\n<p>drogon\u6846\u67b6\u4f1a\u628a\u4f1a\u8bdd\u5bf9\u8c61\u653e\u5230HttpRequest\u5bf9\u8c61\u91cc\u4f20\u9012\u7ed9\u7528\u6237\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7HttpRequest\u7c7b\u7684\u5982\u4e0b\u63a5\u53e3\u83b7\u53d6Session\u5bf9\u8c61\u3002</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">SessionPtr</span> <span class=\"nf\">session</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n</pre></div>\n</div>\n<p>\u83b7\u5f97\u7684\u662fSession\u5bf9\u8c61\u7684\u667a\u80fd\u6307\u9488\uff0c\u901a\u8fc7\u5b83\u53ef\u4ee5\u5b58\u53d6\u5404\u79cd\u5bf9\u8c61\uff1b</p>\n</div>\n<div class=\"section\" id=\"id5\">\n<h2>\u4f1a\u8bdd\u7684\u4f8b\u5b50<a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>\u6211\u4eec\u8fd9\u6b21\u52a0\u4e00\u4e2a\u9700\u8981\u4f1a\u8bdd\u652f\u6301\u7684\u529f\u80fd\uff0c\u6bd4\u5982\uff0c\u6211\u4eec\u8981\u9650\u5236\u7528\u6237\u7684\u8bbf\u95ee\u9891\u5ea6\uff0c\u67d0\u4e00\u6b21\u8bbf\u95ee\u540e\uff0c\u5982\u679c10\u79d2\u4ee5\u5185\u518d\u6b21\u8bbf\u95ee\uff0c\u5c31\u8fd4\u56de\u9519\u8bef\uff0c\u5426\u5219\u8fd4\u56deok\u3002\u6211\u4eec\u9700\u8981\u5728\u4f1a\u8bdd\u91cc\u8bb0\u5f55\u4e0a\u6b21\u8bbf\u95ee\u7684\u65f6\u95f4\uff0c\u7136\u540e\u548c\u672c\u6b21\u8bbf\u95ee\u7684\u65f6\u95f4\u505a\u6bd4\u8f83\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u3002</p>\n<p>\u6211\u4eec\u521b\u5efa\u4e00\u4e2aFilter\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u5047\u8bbe\u7c7b\u540d\u662fTimeFilter\uff0c\u5b9e\u73b0\u5982\u4e0b\uff1a</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&quot;TimeFilter.h&quot;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;trantor/utils/Date.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;trantor/utils/Logger.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#define VDate &quot;visitDate&quot;</span>\n<span class=\"kt\">void</span> <span class=\"n\">TimeFilter</span><span class=\"o\">::</span><span class=\"n\">doFilter</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span>\n                        <span class=\"n\">FilterCallback</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">cb</span><span class=\"p\">,</span>\n                        <span class=\"n\">FilterChainCallback</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">ccb</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span> <span class=\"n\">now</span><span class=\"o\">=</span><span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span><span class=\"o\">::</span><span class=\"n\">date</span><span class=\"p\">();</span>\n    <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;&quot;</span><span class=\"p\">;</span>\n    <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">))</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">auto</span> <span class=\"n\">lastDate</span><span class=\"o\">=</span><span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">get</span><span class=\"o\">&lt;</span><span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">);</span>\n        <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;last:&quot;</span><span class=\"o\">&lt;&lt;</span><span class=\"n\">lastDate</span><span class=\"p\">.</span><span class=\"n\">toFormattedString</span><span class=\"p\">(</span><span class=\"nb\">false</span><span class=\"p\">);</span>\n        <span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">,</span><span class=\"n\">now</span><span class=\"p\">);</span>\n        <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;update visitDate&quot;</span><span class=\"p\">;</span>\n        <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">now</span><span class=\"o\">&gt;</span><span class=\"n\">lastDate</span><span class=\"p\">.</span><span class=\"n\">after</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">))</span>\n        <span class=\"p\">{</span>\n            <span class=\"c1\">//10 sec later can visit again;</span>\n            <span class=\"n\">ccb</span><span class=\"p\">();</span>\n            <span class=\"k\">return</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">else</span>\n        <span class=\"p\">{</span>\n            <span class=\"n\">Json</span><span class=\"o\">::</span><span class=\"n\">Value</span> <span class=\"n\">json</span><span class=\"p\">;</span>\n            <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;result&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;error&quot;</span><span class=\"p\">;</span>\n            <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;message&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;Access interval should be at least 10 seconds&quot;</span><span class=\"p\">;</span>\n            <span class=\"k\">auto</span> <span class=\"n\">res</span><span class=\"o\">=</span><span class=\"n\">HttpResponse</span><span class=\"o\">::</span><span class=\"n\">newHttpJsonResponse</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"p\">);</span>\n            <span class=\"n\">cb</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">);</span>\n            <span class=\"k\">return</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;first access,insert visitDate&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">,</span><span class=\"n\">now</span><span class=\"p\">);</span>\n    <span class=\"n\">ccb</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n<p>\u6211\u4eec\u518d\u6ce8\u518c\u4e00\u4e2alambda\u8868\u8fbe\u5f0f\u5230/slow\u8def\u5f84\u4e0a\uff0c\u540c\u65f6\u9644\u52a0\u4e0aTimeFilter\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">HttpAppFramework</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">()</span>\n            <span class=\"p\">.</span><span class=\"n\">registerHttpMethod</span><span class=\"p\">(</span><span class=\"s\">&quot;/slow&quot;</span><span class=\"p\">,</span>\n                               <span class=\"p\">[</span><span class=\"o\">=</span><span class=\"p\">](</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span>\n                                   <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">function</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span> <span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpResponsePtr</span> <span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"o\">&gt;</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">callback</span><span class=\"p\">)</span>\n                               <span class=\"p\">{</span>\n                                   <span class=\"n\">Json</span><span class=\"o\">::</span><span class=\"n\">Value</span> <span class=\"n\">json</span><span class=\"p\">;</span>\n                                   <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;result&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;ok&quot;</span><span class=\"p\">;</span>\n                                   <span class=\"k\">auto</span> <span class=\"n\">resp</span><span class=\"o\">=</span><span class=\"n\">HttpResponse</span><span class=\"o\">::</span><span class=\"n\">newHttpJsonResponse</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"p\">);</span>\n                                   <span class=\"n\">callback</span><span class=\"p\">(</span><span class=\"n\">resp</span><span class=\"p\">);</span>\n                               <span class=\"p\">},</span>\n                               <span class=\"p\">{</span><span class=\"n\">Get</span><span class=\"p\">,</span><span class=\"s\">&quot;TimeFilter&quot;</span><span class=\"p\">});</span>\n</pre></div>\n</div>\n<p>\u8c03\u7528\u6846\u67b6\u63a5\u53e3\u6253\u5f00\u4f1a\u8bdd</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">HttpAppFramework</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">().</span><span class=\"n\">enableSession</span><span class=\"p\">(</span><span class=\"mi\">1200</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n<p>\u7528cmake\u91cd\u65b0\u7f16\u8bd1\u6574\u4e2a\u5de5\u7a0b\uff0c\u8fd0\u884c\u76ee\u6807\u7a0b\u5e8fwebapp\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u770b\u5230\u6548\u679c\u4e86\u3002</p>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["Database-General-zh", "\u6570\u636e\u5e93 \u6982\u8ff0", "N", "next"], ["View-zh", "\u89c6\u56fe", "P", "previous"]], "sourcename": "Session-zh.rstd.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">\u4f1a\u8bdd</a><ul>\n<li><a class=\"reference internal\" href=\"#id4\">\u4f1a\u8bdd\u5bf9\u8c61</a></li>\n<li><a class=\"reference internal\" href=\"#id5\">\u4f1a\u8bdd\u7684\u4f8b\u5b50</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rstd", "current_page_name": "Session-zh", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}