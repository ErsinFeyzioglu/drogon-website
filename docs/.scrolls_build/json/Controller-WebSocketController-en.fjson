{"parents": [{"link": "../index-en/", "title": "English documentation"}], "prev": {"link": "../Controller-HttpController-en/", "title": "Controller HttpController"}, "next": {"link": "../Filter-en/", "title": "Filter"}, "title": "Controller WebSocketController", "meta": {}, "body": "<div class=\"section\" id=\"controller-websocketcontroller\">\n<h1>Controller WebSocketController<a class=\"headerlink\" href=\"#controller-websocketcontroller\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<div class=\"section\" id=\"websocketcontroller\">\n<h2>WebSocketController<a class=\"headerlink\" href=\"#websocketcontroller\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>As the name implies, <em>WebSocketController</em> is used to process websocket logic. Websocket is a persistent HTTP-based connection scheme. At the beginning of the websocket, there is an HTTP format request and response exchange. After the websocket connection is established, all messages are transmitted on the websocket. The message is wrapped in a fixed format. There is no limit to the message content and the order in which messages are transmitted.</p>\n<p>The source file of the <em>WebSocketController</em> can be generated by the <em>drogon_ctl</em> tool. The command format is as follows:</p>\n<div class=\"highlight-bash notranslate\"><div class=\"highlight\"><pre><span></span>drogon_ctl create controller -w &lt;<span class=\"o\">[</span>namespace::<span class=\"o\">]</span>class_name&gt;\n</pre></div>\n</div>\n<p>Suppose we want to implement a simple echo function through websocket, that is, the server simply sends back the message sent by the client. We can create the implementation class EchoWebsock of <em>WebSocketController</em> through <em>drogon_ctl</em>, as follows:</p>\n<div class=\"highlight-bash notranslate\"><div class=\"highlight\"><pre><span></span>drogon_ctl create controller -w EchoWebsock\n</pre></div>\n</div>\n<p>The command will generate two files of EchoWebsock.h and EchoWebsock.cc,as follows:</p>\n<div class=\"literal-block-wrapper docutils container\" id=\"id1\">\n<div class=\"code-block-caption\"><span class=\"caption-text\"><em>EchoWebsock.h</em></span><a class=\"headerlink\" href=\"#id1\" title=\"Permalink to this code\">\u00b6</a></div>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#pragma once</span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;drogon/WebSocketController.h&gt;</span><span class=\"cp\"></span>\n<span class=\"k\">using</span> <span class=\"k\">namespace</span> <span class=\"n\">drogon</span><span class=\"p\">;</span>\n<span class=\"k\">class</span> <span class=\"nc\">EchoWebsock</span><span class=\"o\">:</span><span class=\"k\">public</span> <span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">WebSocketController</span><span class=\"o\">&lt;</span><span class=\"n\">EchoWebsock</span><span class=\"o\">&gt;</span>\n<span class=\"p\">{</span>\n<span class=\"k\">public</span><span class=\"o\">:</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleNewMessage</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">,</span>\n                                <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"o\">&amp;&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleNewConnection</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"p\">,</span>\n                                    <span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleConnectionClosed</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"n\">WS_PATH_LIST_BEGIN</span>\n    <span class=\"c1\">//list path definitions here;</span>\n    <span class=\"n\">WS_PATH_LIST_END</span>\n<span class=\"p\">};</span>\n</pre></div>\n</div>\n</div>\n<div class=\"literal-block-wrapper docutils container\" id=\"id2\">\n<div class=\"code-block-caption\"><span class=\"caption-text\"><em>EchoWebsock.cc</em></span><a class=\"headerlink\" href=\"#id2\" title=\"Permalink to this code\">\u00b6</a></div>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&quot;EchoWebsock.h&quot;</span><span class=\"cp\"></span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleNewMessage</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">,</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">message</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n<span class=\"p\">}</span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleNewConnection</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n<span class=\"p\">}</span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleConnectionClosed</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n</div>\n<p>After edited:</p>\n<div class=\"literal-block-wrapper docutils container\" id=\"id3\">\n<div class=\"code-block-caption\"><span class=\"caption-text\"><em>EchoWebsock.h</em></span><a class=\"headerlink\" href=\"#id3\" title=\"Permalink to this code\">\u00b6</a></div>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#pragma once</span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;drogon/WebSocketController.h&gt;</span><span class=\"cp\"></span>\n<span class=\"k\">using</span> <span class=\"k\">namespace</span> <span class=\"n\">drogon</span><span class=\"p\">;</span>\n<span class=\"k\">class</span> <span class=\"nc\">EchoWebsock</span><span class=\"o\">:</span><span class=\"k\">public</span> <span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">WebSocketController</span><span class=\"o\">&lt;</span><span class=\"n\">EchoWebsock</span><span class=\"o\">&gt;</span>\n<span class=\"p\">{</span>\n<span class=\"k\">public</span><span class=\"o\">:</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleNewMessage</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">,</span>\n                                <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"o\">&amp;&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleNewConnection</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"p\">,</span>\n                                    <span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"k\">virtual</span> <span class=\"kt\">void</span> <span class=\"n\">handleConnectionClosed</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span><span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"k\">override</span><span class=\"p\">;</span>\n    <span class=\"n\">WS_PATH_LIST_BEGIN</span>\n    <span class=\"c1\">//list path definitions here;</span>\n    <span class=\"n\">WS_PATH_ADD</span><span class=\"p\">(</span><span class=\"s\">&quot;/echo&quot;</span><span class=\"p\">);</span>\n    <span class=\"n\">WS_PATH_LIST_END</span>\n<span class=\"p\">};</span>\n</pre></div>\n</div>\n</div>\n<div class=\"literal-block-wrapper docutils container\" id=\"id4\">\n<div class=\"code-block-caption\"><span class=\"caption-text\"><em>EchoWebsock.cc</em></span><a class=\"headerlink\" href=\"#id4\" title=\"Permalink to this code\">\u00b6</a></div>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&quot;EchoWebsock.h&quot;</span><span class=\"cp\"></span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleNewMessage</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">,</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">message</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n    <span class=\"n\">wsConnPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleNewConnection</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n<span class=\"p\">}</span>\n<span class=\"kt\">void</span> <span class=\"n\">EchoWebsock</span><span class=\"o\">::</span><span class=\"n\">handleConnectionClosed</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">WebSocketConnectionPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">wsConnPtr</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">//write your application logic here</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n</div>\n<p>First, in this example, the controller is registered to the <em>/echo</em> path via the <em>WS_PATH_ADD</em> macro. The usage of the <em>WS_PATH_ADD</em> macro is similar to the macros of other controllers introduced earlier. One can also register the path with several Filters. Since websocket is handled separately in the framework, it can be repeated with the paths of the first two controllers\uff08<em>HttpSimpleController</em> and <em>HttpApiController</em>\uff09 without affecting each other.</p>\n<p>Secondly, in the implementation of the three virtual functions in this example, only the handleNewMessage has the substance, but simply sends the received message back to the client through the send interface.Compile this controller into the framework, you can see the effect, please test it yourself.</p>\n<div class=\"admonition note\">\n<p class=\"first admonition-title\">Note</p>\n<p class=\"last\">Note: Like the usual HTTP protocol, http websocket can be sniffed. If security is required, encryption should be provided by HTTPS. Of course, it is also possible for users to complete encryption and decryption on the server and client side, but HTTPS is more convenient. The underlying layer is handled by drogon, and users only need to care about business logic.</p>\n</div>\n<p>The user-defined websocket controller class inherits from the drogon::WebSocketController class template. The template parameter is a subclass type. The user needs to implement the following three virtual functions to process the establishment, shutdown, and messages of the websocket:</p>\n<p>Easy to know:</p>\n<blockquote>\n<div><ul class=\"simple\">\n<li>handleNewConnection is called after the websocket is established. req is the setup request sent by the client. At this time, the framework has returned the response. What users can do is to get some additional information through req, such as token. wsConn is a smart pointer to this websocket object, and the commonly used interface will be discussed later.</li>\n<li>handleNewMessage is called after the websocket receives the new message. The message is stored in the message variable. Note that the message is the message payload. The framework has finished the decapsulation and decoding of the message. The user can directly process the message itself.</li>\n<li>handleConnectionClosed is called after the websocket connection is closed, and the user can do some finishing work.</li>\n</ul>\n</div></blockquote>\n</div>\n<div class=\"section\" id=\"websocketconnection\">\n<h2>WebSocketConnection<a class=\"headerlink\" href=\"#websocketconnection\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>The common interfaces of the WebSocketConnection object are as follows:</p>\n<div class=\"literal-block-wrapper docutils container\" id=\"id5\">\n<div class=\"code-block-caption\"><span class=\"caption-text\"><em>WebSocketConnection.h</em></span><a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this code\">\u00b6</a></div>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\">//Send a websocket message, the encoding and encapsulation</span>\n<span class=\"c1\">//of the message are the responsibility of the framework</span>\n<span class=\"kt\">void</span> <span class=\"nf\">send</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"kt\">char</span> <span class=\"o\">*</span><span class=\"n\">msg</span><span class=\"p\">,</span><span class=\"kt\">uint64_t</span> <span class=\"n\">len</span><span class=\"p\">);</span>\n<span class=\"kt\">void</span> <span class=\"nf\">send</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"o\">&amp;</span><span class=\"n\">msg</span><span class=\"p\">);</span>\n\n<span class=\"c1\">//Local and remote addresses of the websocket</span>\n<span class=\"k\">const</span> <span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">InetAddress</span> <span class=\"o\">&amp;</span><span class=\"n\">localAddr</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">InetAddress</span> <span class=\"o\">&amp;</span><span class=\"n\">peerAddr</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n\n<span class=\"c1\">//The connection state of the weosocket</span>\n<span class=\"kt\">bool</span> <span class=\"nf\">connected</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n<span class=\"kt\">bool</span> <span class=\"nf\">disconnected</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n\n<span class=\"c1\">//close websocket</span>\n<span class=\"kt\">void</span> <span class=\"nf\">shutdown</span><span class=\"p\">();</span><span class=\"c1\">//close write</span>\n<span class=\"kt\">void</span> <span class=\"nf\">forceClose</span><span class=\"p\">();</span><span class=\"c1\">//close</span>\n\n<span class=\"c1\">//set up and get the context of the websocket, and store some business data from users.</span>\n<span class=\"c1\">//the any type means that you can store any type of object.</span>\n<span class=\"kt\">void</span> <span class=\"nf\">setContext</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">any</span> <span class=\"o\">&amp;</span><span class=\"n\">context</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"n\">any</span> <span class=\"o\">&amp;</span><span class=\"n\">getContext</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n<span class=\"n\">any</span> <span class=\"o\">*</span><span class=\"nf\">getMutableContext</span><span class=\"p\">();</span>\n</pre></div>\n</div>\n</div>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["Filter-en", "Filter", "N", "next"], ["Controller-HttpController-en", "Controller HttpController", "P", "previous"]], "sourcename": "Controller-WebSocketController-en.rstd.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Controller WebSocketController</a><ul>\n<li><a class=\"reference internal\" href=\"#websocketcontroller\">WebSocketController</a></li>\n<li><a class=\"reference internal\" href=\"#websocketconnection\">WebSocketConnection</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rstd", "current_page_name": "Controller-WebSocketController-en", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}