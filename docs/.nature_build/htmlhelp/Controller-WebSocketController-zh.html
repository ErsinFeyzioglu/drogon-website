
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    <title>&#25511;&#21046;&#22120; WebSocketController</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="next" title="&#36807;&#28388;&#22120;" href="Filter-zh.html" />
    <link rel="prev" title="HttpController &#25511;&#21046;&#22120;" href="Controller-HttpController-zh.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Filter-zh.html" title="&#36807;&#28388;&#22120;"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Controller-HttpController-zh.html" title="HttpController &#25511;&#21046;&#22120;"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">drogon v1.0.0-beta21 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index-zh.html" accesskey="U">&#20013;&#25991;&#25991;&#26723;</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="websocketcontroller">
<h1>&#25511;&#21046;&#22120; WebSocketController</h1>
<div class="section" id="id1">
<h2>WebSocketController</h2>
<p>&#39038;&#21517;&#24605;&#20041;&#65292;<a href="#id2"><span class="problematic" id="id3">*</span></a>WebSocketController*&#29992;&#20110;&#22788;&#29702;websocket&#36923;&#36753;&#12290;websocket&#26159;&#22522;&#20110;HTTP&#30340;&#19968;&#31181;&#38271;&#36830;&#25509;&#26041;&#26696;&#65292;&#22312;websocket&#24314;&#31435;&#20043;&#21021;&#65292;&#26377;&#19968;&#27425;HTTP&#26684;&#24335;&#30340;&#35831;&#27714;&#21644;&#24212;&#31572;&#20132;&#25442;&#65292;&#24314;&#31435;&#23436;&#25104;&#21518;&#65292;&#25152;&#26377;&#30340;&#28040;&#24687;&#22312;websocket&#19978;&#20256;&#36755;&#65292;&#28040;&#24687;&#30001;&#22266;&#23450;&#30340;&#26684;&#24335;&#21253;&#35013;&#65292;&#20294;&#28040;&#24687;&#30340;&#20869;&#23481;&#21644;&#25910;&#21457;&#27425;&#24207;&#27809;&#26377;&#20219;&#20309;&#35201;&#27714;&#65292;&#23436;&#20840;&#30001;&#29992;&#25143;&#23450;&#20041;&#12290;</p>
<p>&#21487;&#20197;&#30001;*drogon_ctl*&#24037;&#20855;&#24555;&#36895;&#29983;&#25104;*WebSocketController*&#30340;&#28304;&#25991;&#20214;&#65292;&#21629;&#20196;&#26684;&#24335;&#22914;&#19979;&#65306;:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>drogon_ctl create controller -w &lt;<span class="o">[</span>namespace::<span class="o">]</span>class_name&gt;
</pre></div>
</div>
<p>&#20551;&#35774;&#25105;&#20204;&#35201;&#36890;&#36807;websocket&#23454;&#29616;&#19968;&#20010;&#31616;&#21333;&#30340;&#22238;&#22768;&#21151;&#33021;&#65292;&#21363;&#26381;&#21153;&#31471;&#21482;&#26159;&#31616;&#21333;&#30340;&#25226;&#23458;&#25143;&#31471;&#21457;&#26469;&#30340;&#28040;&#24687;&#20877;&#21457;&#22238;&#21435;&#65292;&#36890;&#36807;drogon_ctl&#21019;&#24314;WebSocketController&#30340;&#23454;&#29616;&#31867;EchoWebsock&#65292;&#22914;&#19979;:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>drogon_ctl create controller -w EchoWebsock
</pre></div>
</div>
<p>&#35813;&#21629;&#20196;&#20250;&#29983;&#25104;EchoWebsock.h&#21644;EchoWebsock.cc&#20004;&#20010;&#25991;&#20214;&#65292;</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><em>EchoWebsock.h</em></span></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>
<span class="cp">#include</span> <span class="cpf">&lt;drogon/WebSocketController.h&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">drogon</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">EchoWebsock</span><span class="o">:</span><span class="k">public</span> <span class="n">drogon</span><span class="o">::</span><span class="n">WebSocketController</span><span class="o">&lt;</span><span class="n">EchoWebsock</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleNewMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleNewConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleConnectionClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="n">WS_PATH_LIST_BEGIN</span>
    <span class="c1">//list path definitions here;</span>
    <span class="n">WS_PATH_LIST_END</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><em>EchoWebsock.cc</em></span></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;EchoWebsock.h&quot;</span><span class="cp"></span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleNewMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleNewConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleConnectionClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>&#32534;&#36753;&#21518;&#20869;&#23481;&#22914;&#19979;&#65306;</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text"><em>EchoWebsock.h</em></span></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>
<span class="cp">#include</span> <span class="cpf">&lt;drogon/WebSocketController.h&gt;</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">drogon</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">EchoWebsock</span><span class="o">:</span><span class="k">public</span> <span class="n">drogon</span><span class="o">::</span><span class="n">WebSocketController</span><span class="o">&lt;</span><span class="n">EchoWebsock</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleNewMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleNewConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">handleConnectionClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="k">override</span><span class="p">;</span>
    <span class="n">WS_PATH_LIST_BEGIN</span>
    <span class="c1">//list path definitions here;</span>
    <span class="n">WS_PATH_ADD</span><span class="p">(</span><span class="s">&quot;/echo&quot;</span><span class="p">);</span>
    <span class="n">WS_PATH_LIST_END</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text"><em>EchoWebsock.cc</em></span></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;EchoWebsock.h&quot;</span><span class="cp"></span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleNewMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;&amp;</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
    <span class="n">wsConnPtr</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleNewConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">EchoWebsock</span><span class="o">::</span><span class="n">handleConnectionClosed</span><span class="p">(</span><span class="k">const</span> <span class="n">WebSocketConnectionPtr</span> <span class="o">&amp;</span><span class="n">wsConnPtr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//write your application logic here</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>&#39318;&#20808;&#65292;&#22312;&#36825;&#20010;&#20363;&#23376;&#20013;&#65292;&#36890;&#36807;*WS_PATH_ADD*&#23439;&#25226;&#36825;&#20010;&#25511;&#21046;&#22120;&#27880;&#20876;&#21040;&#20102;*/echo*&#36335;&#24452;&#19978;&#65292;<a href="#id4"><span class="problematic" id="id5">*</span></a>WS_PATH_ADD*&#23439;&#30340;&#29992;&#27861;&#36319;&#20043;&#21069;&#20171;&#32461;&#30340;&#20854;&#20182;&#25511;&#21046;&#22120;&#30340;&#23439;&#31867;&#20284;&#65292;&#20063;&#21487;&#20197;&#27880;&#20876;&#36335;&#24452;&#24182;&#19988;&#38468;&#24102;&#33509;&#24178;&#36807;&#28388;&#22120;Filter&#12290;&#30001;&#20110;websocket&#22312;&#26694;&#26550;&#20013;&#21333;&#29420;&#22788;&#29702;&#65292;&#25152;&#20197;&#23427;&#21487;&#20197;&#21644;&#21069;&#20004;&#31181;&#25511;&#21046;&#22120;&#30340;&#36335;&#24452;&#37325;&#22797;&#32780;&#19981;&#20250;&#30456;&#20114;&#24433;&#21709;&#12290;</p>
<p>&#20854;&#27425;&#65292;&#26412;&#20363;&#20013;&#19977;&#20010;&#34394;&#20989;&#25968;&#30340;&#23454;&#29616;&#65292;&#21482;&#26377;handleNewMessage&#26377;&#23454;&#36136;&#20869;&#23481;&#65292;&#21482;&#26159;&#31616;&#21333;&#30340;&#25226;&#25910;&#21040;&#30340;&#28040;&#24687;&#36890;&#36807;send&#25509;&#21475;&#21457;&#22238;&#23458;&#25143;&#31471;&#12290;&#25226;&#36825;&#20010;&#25511;&#21046;&#22120;&#32534;&#35793;&#36827;&#26694;&#26550;&#65292;&#23601;&#21487;&#20197;&#30475;&#21040;&#25928;&#26524;&#65292;&#35831;&#21508;&#20301;&#33258;&#24049;&#35797;&#39564;&#21543;&#12290;</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#27880;&#24847;&#65306;&#21644;&#36890;&#24120;&#30340;HTTP&#21327;&#35758;&#19968;&#26679;&#65292;http&#30340;websocket&#21487;&#20197;&#34987;&#26049;&#36335;&#36824;&#21407;&#65292;&#22914;&#26524;&#38656;&#35201;&#23433;&#20840;&#20445;&#38556;&#65292;&#24212;&#30001;https&#25552;&#20379;&#21152;&#23494;&#21151;&#33021;&#65292;&#24403;&#28982;&#65292;&#29992;&#25143;&#33258;&#24049;&#22312;&#26381;&#21153;&#31471;&#21644;&#23458;&#25143;&#31471;&#23436;&#25104;&#21152;&#23494;&#21644;&#35299;&#23494;&#20063;&#26159;&#21487;&#20197;&#30340;&#65292;&#21482;&#26159;https&#26356;&#26041;&#20415;&#65292;&#24213;&#23618;&#37117;&#30001;drogon&#22788;&#29702;&#65292;&#29992;&#25143;&#21482;&#38656;&#20851;&#24515;&#19994;&#21153;&#36923;&#36753;&#12290;</p>
</div>
<p>&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;WebSocketController&#31867;&#32487;&#25215;&#33258;drogon::WebSocketController&#31867;&#27169;&#26495;&#65292;&#27169;&#26495;&#21442;&#25968;&#26159;&#23376;&#31867;&#31867;&#22411;&#65292;&#29992;&#25143;&#38656;&#33258;&#24049;&#23454;&#29616;&#22914;&#19979;&#19977;&#20010;&#34394;&#20989;&#25968;&#26469;&#23545;websocket&#30340;&#24314;&#31435;&#12289;&#20851;&#38381;&#21644;&#28040;&#24687;&#36827;&#34892;&#22788;&#29702;&#65306;</p>
<p>&#23481;&#26131;&#30693;&#36947;:</p>
<blockquote>
<div><ul class="simple">
<li>handleNewConnection is called after the websocket is established. req is the setup request sent by the client. At this time, the framework has returned the response. What users can do is to get some additional information through req, such as token. wsConn is a smart pointer to this websocket object, and the commonly used interface will be discussed later.</li>
<li>handleNewMessage is called after the websocket receives the new message. The message is stored in the message variable. Note that the message is the message payload. The framework has finished the decapsulation and decoding of the message. The user can directly process the message itself.</li>
<li>handleConnectionClosed is called after the websocket connection is closed, and the user can do some finishing work.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="websocketconnection">
<h2>WebSocketConnection</h2>
<p>WebSocketConnection&#23545;&#35937;&#24120;&#29992;&#25509;&#21475;&#22914;&#19979;&#65306;</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text"><em>WebSocketConnection.h</em></span></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//&#21457;&#36865;websocket&#28040;&#24687;&#65292;&#28040;&#24687;&#30340;&#32534;&#30721;&#21644;&#23553;&#21253;&#37117;&#30001;&#26694;&#26550;&#36127;&#36131;&#65292;&#36825;&#37324;&#30452;&#25509;&#21457;&#36865;&#28040;&#24687;&#30340;&#20928;&#33655;</span>
<span class="c1">//of the message are the responsibility of the framework</span>
<span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span><span class="kt">uint64_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

<span class="c1">//&#26412;websocket&#30340;&#26412;&#31471;&#21644;&#36828;&#31471;&#22320;&#22336;</span>
<span class="k">const</span> <span class="n">trantor</span><span class="o">::</span><span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">localAddr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="k">const</span> <span class="n">trantor</span><span class="o">::</span><span class="n">InetAddress</span> <span class="o">&amp;</span><span class="n">peerAddr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="c1">//&#26412;weosocket&#30340;&#36830;&#25509;&#29366;&#24577;</span>
<span class="kt">bool</span> <span class="nf">connected</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="kt">bool</span> <span class="nf">disconnected</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="c1">//&#20851;&#38381;&#26412;websocket</span>
<span class="kt">void</span> <span class="nf">shutdown</span><span class="p">();</span><span class="c1">//close write</span>
<span class="kt">void</span> <span class="nf">forceClose</span><span class="p">();</span><span class="c1">//close</span>

<span class="c1">//&#35774;&#32622;&#21644;&#33719;&#21462;&#26412;websocket&#30340;&#19978;&#19979;&#25991;&#65292;&#30001;&#29992;&#25143;&#23384;&#20837;&#19968;&#20123;&#19994;&#21153;&#25968;&#25454;&#65292;</span>
<span class="c1">//any&#31867;&#22411;&#24847;&#21619;&#30528;&#21487;&#20197;&#23384;&#21462;&#20219;&#24847;&#31867;&#22411;&#30340;&#23545;&#35937;&#12290;</span>
<span class="kt">void</span> <span class="nf">setContext</span><span class="p">(</span><span class="k">const</span> <span class="n">any</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
<span class="k">const</span> <span class="n">any</span> <span class="o">&amp;</span><span class="n">getContext</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="n">any</span> <span class="o">*</span><span class="nf">getMutableContext</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Filter-zh.html" title="&#36807;&#28388;&#22120;"
             >next</a> |</li>
        <li class="right" >
          <a href="Controller-HttpController-zh.html" title="HttpController &#25511;&#21046;&#22120;"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">drogon v1.0.0-beta21 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index-zh.html" >&#20013;&#25991;&#25991;&#26723;</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, an-tao.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>