{"parents": [{"link": "../index-en/", "title": "English documentation"}], "prev": {"link": "../View-en/", "title": "View"}, "next": {"link": "../Database-General-en/", "title": "Database General"}, "title": "Session", "meta": {}, "body": "<div class=\"section\" id=\"session\">\n<h1>Session<a class=\"headerlink\" href=\"#session\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p><em>Session</em> is an important concept of the web application. It is used to save the state of the client on the server. Generally, it cooperates with the browser\u2019s <em>cookie</em>, and drogon provides support for the session. Drogon close the session selection by default, you can also close or open it through the following interface:</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kt\">void</span> <span class=\"nf\">disableSession</span><span class=\"p\">();</span>\n<span class=\"kt\">void</span> <span class=\"nf\">enableSession</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"kt\">size_t</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n<p>The above methods are all called through the <em>HttpAppFramework</em> singleton. The timeout parameter represents the time when the session is invalid. The unit is second. The default value is 1200. That is, if the user does not access the web application for more than 20 minutes, the corresponding session will be invalid. Setting timeout to 0 means that drogon will retain the user\u2019s session for the entire lifetime;</p>\n<p>Make sure your client supports cookies before opening the session feature. Otherwise, drogon will create a new session for each request without <em>SessionID</em> cookie, which will waste memory and computing resources.</p>\n<div class=\"section\" id=\"session-object\">\n<h2>Session object<a class=\"headerlink\" href=\"#session-object\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>The session object type of drogon is <em>drogon::Session</em>, which is very similar to <em>HttpViewData</em>. It can access any type of object through keywords; support concurrent reading and writing; please refer to the description of Session class for specific usage;</p>\n<p>The drogon framework will pass the session object to the <em>HttpRequest</em> object and pass it to the user. The user can get the Session object through the following interface of the <em>HttpRequest</em> class.</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">SessionPtr</span> <span class=\"nf\">session</span><span class=\"p\">()</span> <span class=\"k\">const</span><span class=\"p\">;</span>\n</pre></div>\n</div>\n<p>The interface returns a smart pointer of the <em>Session</em> object, through which various objects can be accessed;</p>\n</div>\n<div class=\"section\" id=\"examples-of-sessions\">\n<h2>Examples of sessions<a class=\"headerlink\" href=\"#examples-of-sessions\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>We add a feature that requires session support. For example, we want to limit the user\u2019s access frequency. After a visit, if it is accessed again within 10 seconds, it will return an error, otherwise it will return ok. We need to record the last access time in the session, and then compare it with the time of this visit, you can achieve this function.</p>\n<p>We create a Filter to implement this function, assuming the class name is TimeFilter, the implementation is as follows:</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&quot;TimeFilter.h&quot;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;trantor/utils/Date.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#include</span> <span class=\"cpf\">&lt;trantor/utils/Logger.h&gt;</span><span class=\"cp\"></span>\n<span class=\"cp\">#define VDate &quot;visitDate&quot;</span>\n<span class=\"kt\">void</span> <span class=\"n\">TimeFilter</span><span class=\"o\">::</span><span class=\"n\">doFilter</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span>\n                        <span class=\"n\">FilterCallback</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">cb</span><span class=\"p\">,</span>\n                        <span class=\"n\">FilterChainCallback</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">ccb</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span> <span class=\"n\">now</span><span class=\"o\">=</span><span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span><span class=\"o\">::</span><span class=\"n\">date</span><span class=\"p\">();</span>\n    <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;&quot;</span><span class=\"p\">;</span>\n    <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">))</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">auto</span> <span class=\"n\">lastDate</span><span class=\"o\">=</span><span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">get</span><span class=\"o\">&lt;</span><span class=\"n\">trantor</span><span class=\"o\">::</span><span class=\"n\">Date</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">);</span>\n        <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;last:&quot;</span><span class=\"o\">&lt;&lt;</span><span class=\"n\">lastDate</span><span class=\"p\">.</span><span class=\"n\">toFormattedString</span><span class=\"p\">(</span><span class=\"nb\">false</span><span class=\"p\">);</span>\n        <span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">,</span><span class=\"n\">now</span><span class=\"p\">);</span>\n        <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;update visitDate&quot;</span><span class=\"p\">;</span>\n        <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">now</span><span class=\"o\">&gt;</span><span class=\"n\">lastDate</span><span class=\"p\">.</span><span class=\"n\">after</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">))</span>\n        <span class=\"p\">{</span>\n            <span class=\"c1\">//10 sec later can visit again;</span>\n            <span class=\"n\">ccb</span><span class=\"p\">();</span>\n            <span class=\"k\">return</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">else</span>\n        <span class=\"p\">{</span>\n            <span class=\"n\">Json</span><span class=\"o\">::</span><span class=\"n\">Value</span> <span class=\"n\">json</span><span class=\"p\">;</span>\n            <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;result&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;error&quot;</span><span class=\"p\">;</span>\n            <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;message&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;Access interval should be at least 10 seconds&quot;</span><span class=\"p\">;</span>\n            <span class=\"k\">auto</span> <span class=\"n\">res</span><span class=\"o\">=</span><span class=\"n\">HttpResponse</span><span class=\"o\">::</span><span class=\"n\">newHttpJsonResponse</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"p\">);</span>\n            <span class=\"n\">cb</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">);</span>\n            <span class=\"k\">return</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">LOG_TRACE</span><span class=\"o\">&lt;&lt;</span><span class=\"s\">&quot;first access,insert visitDate&quot;</span><span class=\"p\">;</span>\n    <span class=\"n\">req</span><span class=\"o\">-&gt;</span><span class=\"n\">session</span><span class=\"p\">()</span><span class=\"o\">-&gt;</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">VDate</span><span class=\"p\">,</span><span class=\"n\">now</span><span class=\"p\">);</span>\n    <span class=\"n\">ccb</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n<p>We then register a lambda expression to the <em>/slow</em> path and attach the TimeFilter with the following code:</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">HttpAppFramework</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">()</span>\n            <span class=\"p\">.</span><span class=\"n\">registerHttpMethod</span><span class=\"p\">(</span><span class=\"s\">&quot;/slow&quot;</span><span class=\"p\">,</span>\n                               <span class=\"p\">[</span><span class=\"o\">=</span><span class=\"p\">](</span><span class=\"k\">const</span> <span class=\"n\">HttpRequestPtr</span> <span class=\"o\">&amp;</span><span class=\"n\">req</span><span class=\"p\">,</span>\n                                   <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">function</span><span class=\"o\">&lt;</span><span class=\"kt\">void</span> <span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">HttpResponsePtr</span> <span class=\"o\">&amp;</span><span class=\"p\">)</span><span class=\"o\">&gt;</span> <span class=\"o\">&amp;&amp;</span><span class=\"n\">callback</span><span class=\"p\">)</span>\n                               <span class=\"p\">{</span>\n                                   <span class=\"n\">Json</span><span class=\"o\">::</span><span class=\"n\">Value</span> <span class=\"n\">json</span><span class=\"p\">;</span>\n                                   <span class=\"n\">json</span><span class=\"p\">[</span><span class=\"s\">&quot;result&quot;</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s\">&quot;ok&quot;</span><span class=\"p\">;</span>\n                                   <span class=\"k\">auto</span> <span class=\"n\">resp</span><span class=\"o\">=</span><span class=\"n\">HttpResponse</span><span class=\"o\">::</span><span class=\"n\">newHttpJsonResponse</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"p\">);</span>\n                                   <span class=\"n\">callback</span><span class=\"p\">(</span><span class=\"n\">resp</span><span class=\"p\">);</span>\n                               <span class=\"p\">},</span>\n                               <span class=\"p\">{</span><span class=\"n\">Get</span><span class=\"p\">,</span><span class=\"s\">&quot;TimeFilter&quot;</span><span class=\"p\">});</span>\n</pre></div>\n</div>\n<p>Call the framework interface to open the session:</p>\n<div class=\"highlight-cpp notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">drogon</span><span class=\"o\">::</span><span class=\"n\">HttpAppFramework</span><span class=\"o\">::</span><span class=\"n\">instance</span><span class=\"p\">().</span><span class=\"n\">enableSession</span><span class=\"p\">(</span><span class=\"mi\">1200</span><span class=\"p\">);</span>\n</pre></div>\n</div>\n<p>Recompile the entire project with cmake, run the target program webapp, and you can see the effect through the browser.</p>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["Database-General-en", "Database General", "N", "next"], ["View-en", "View", "P", "previous"]], "sourcename": "Session-en.rstd.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Session</a><ul>\n<li><a class=\"reference internal\" href=\"#session-object\">Session object</a></li>\n<li><a class=\"reference internal\" href=\"#examples-of-sessions\">Examples of sessions</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rstd", "current_page_name": "Session-en", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}